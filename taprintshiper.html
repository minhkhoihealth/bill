<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>In hóa đơn</title>

<style>
body {
  font-family: Arial;
  width: 72mm;
  margin: 0 auto;
  font-size: 13px;
}

h2 {
  text-align: center;
  margin: 3px 0;
}

.info {
  text-align: center;
  font-size: 12px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 5px;
}

th, td {
  border-bottom: 1px dashed #000;
  padding: 3px 0;
  font-size: 12px;
}

th { text-align: left; }
td { text-align: left; }

.right { text-align: right; }
.center { text-align: center; }

.total-section {
  margin-top: 5px;
  border-top: 1px solid #000;
  padding-top: 5px;
}

.bold { font-weight: bold; }

.qrcode-box, .barcode-box {
  text-align: center;
  margin-top: 5px;
}

.footer {
  text-align: center;
  margin-top: 8px;
  font-size: 12px;
}

@media print {
  button { display: none; }
}
</style>
</head>

<body onload="autoPrint()">

<h2 id="storeName"></h2>
<div class="info" id="storeAddress"></div>
<div class="info" id="storePhone"></div>

<hr>

<div><strong>Mã đơn:</strong> <span id="orderId"></span></div>
<div><strong>Bàn:</strong> <span id="ban"></span></div>
<div><strong>Khách:</strong> <span id="customerName"></span></div>
<div><strong>Địa chỉ:</strong> <span id="customerAddress"></span></div>

<div class="barcode-box">
  <img id="barcode" width="180">
</div>

<table>
<thead>
<tr>
<th>SP</th>
<th class="center">SL</th>
<th class="right">TT</th>
</tr>
</thead>
<tbody id="productBody"></tbody>
</table>

<div class="total-section">
  <div class="right">Tổng tiền: <span id="paymentAmount"></span></div>
  <div class="right" id="giamgiaRow">Giảm giá: <span id="giamgia"></span></div>
  <div class="right" id="phuthuRow">Phụ thu: <span id="phuthu"></span></div>
  <div class="right bold" style="font-size:15px;">
    THANH TOÁN: <span id="tongthanhtoan"></span>
  </div>
</div>

<div class="qrcode-box">
  <img id="qrcode" width="150">
</div>

<div class="footer" id="datetime"></div>
<div class="footer">Cảm ơn quý khách!</div>

<button onclick="window.print()">In lại</button>

<script>
const params = new URLSearchParams(window.location.search);

function formatMoney(n) {
  return Number(n || 0).toLocaleString("vi-VN");
}

// Cửa hàng
document.getElementById("storeName").textContent = params.get("tencuahang") || "";
document.getElementById("storeAddress").textContent = params.get("diachicuahang") || "";
document.getElementById("storePhone").textContent = params.get("dienthoaicuahang") || "";

// Đơn hàng
const orderId = params.get("id") || "";
document.getElementById("orderId").textContent = orderId;
document.getElementById("ban").textContent = params.get("ban") || "";
document.getElementById("customerName").textContent = params.get("ten") || "";
document.getElementById("customerAddress").textContent = params.get("diachi") || "";

// Tiền
const tongTien = params.get("thanhtoan");
const giamgia = params.get("giamgia");
const phuthu = params.get("phuthu");
const tongThanhToan = params.get("tongthanhtoan");

document.getElementById("paymentAmount").textContent = formatMoney(tongTien);
document.getElementById("giamgia").textContent = formatMoney(giamgia);
document.getElementById("phuthu").textContent = formatMoney(phuthu);
document.getElementById("tongthanhtoan").textContent = formatMoney(tongThanhToan);

// Ẩn nếu = 0
if (!giamgia || Number(giamgia) == 0)
  document.getElementById("giamgiaRow").style.display = "none";

if (!phuthu || Number(phuthu) == 0)
  document.getElementById("phuthuRow").style.display = "none";

// Barcode
document.getElementById("barcode").src =
"https://barcode.tec-it.com/barcode.ashx?code=Code128&data=" + orderId;

// Danh sách sản phẩm
const data = decodeURIComponent(params.get("data") || "").split("_n_");
let total = 0;
let tbody = document.getElementById("productBody");

data.forEach(row => {
  if (!row.trim()) return;
  const parts = row.split("|");
  const name = parts[1] || "";
  const qty = parts[3] || 0;
  const amount = parts[5] || 0;

  total += Number(amount);

  let tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${name}</td>
    <td class="center">${qty}</td>
    <td class="right">${formatMoney(amount)}</td>
  `;
  tbody.appendChild(tr);
});

// QR VietQR
const bank = params.get("bank");
const stk = params.get("stk");
const chutk = params.get("chutk");

if (bank && stk && chutk && tongThanhToan) {
  document.getElementById("qrcode").src =
    `https://img.vietqr.io/image/${bank}-${stk}-compact2.jpg?amount=${tongThanhToan}&addInfo=${orderId}&accountName=${encodeURIComponent(chutk)}`;
} else {
  document.getElementById("qrcode").style.display = "none";
}

// Ngày giờ
document.getElementById("datetime").textContent =
"Ngày in: " + new Date().toLocaleString("vi-VN");

// Tự động in
function autoPrint() {
  setTimeout(() => {
    window.print();
  }, 500);
}
</script>

</body>
</html>
