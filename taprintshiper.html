<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>H√≥a ƒë∆°n b√°n h√†ng</title>
<style>
  body { font-family: Arial; margin: 20px; }
  h2 { text-align: center; margin-bottom: 2px; }
  .info { text-align: center; margin-bottom: 5px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  table, th, td { border: 1px solid black; }
  th, td { padding: 5px; text-align: center; }
  .total-row { font-weight: bold; }
  .barcode-box, .qrcode-box { text-align: center; margin: 10px 0; }
  .footer { text-align: center; margin-top: 15px; font-style: italic; }
  .print-btn { margin: 10px 0; text-align: center; }
</style>
</head>

<body>

<h2 id="storeName">C·ª≠a h√†ng</h2>
<div class="info" id="storeAddress"></div>
<div class="info" id="storePhone"></div>

<h2>H√ìA ƒê∆†N B√ÅN H√ÄNG</h2>

<div class="barcode-box">
  <img id="barcode" alt="Barcode">
</div>

<div class="print-btn">
  <button onclick="window.print()">üñ® In h√≥a ƒë∆°n</button>
</div>

<p><strong>M√£ ƒë∆°n:</strong> <span id="orderId"></span></p>
<p><strong>B√†n:</strong> <span id="ban"></span></p>
<p><strong>Kh√°ch h√†ng:</strong> <span id="customerName"></span></p>
<p><strong>ƒê·ªãa ch·ªâ:</strong> <span id="customerAddress"></span></p>

<p><strong>T·ªïng ti·ªÅn:</strong> <span id="paymentAmount"></span> VND</p>
<p id="giamgiaRow"><strong>Gi·∫£m gi√°:</strong> <span id="giamgia"></span> VND</p>
<p id="phuthuRow"><strong>Ph·ª• thu:</strong> <span id="phuthu"></span> VND</p>
<p><strong>T·ªïng thanh to√°n:</strong> <span id="tongthanhtoan"></span> VND</p>

<table id="productTable">
<thead>
<tr>
<th>STT</th>
<th>T√™n h√†ng</th>
<th>SL</th>
<th>ƒê∆°n gi√°</th>
<th>Th√†nh ti·ªÅn</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr class="total-row">
<td colspan="2">T·ªîNG C·ªòNG</td>
<td id="totalQty"></td>
<td></td>
<td id="totalPrice"></td>
</tr>
</tfoot>
</table>

<div class="qrcode-box">
<h3>QR Thanh to√°n</h3>
<img id="qrcode" width="150">
</div>

<div class="footer" id="datetime"></div>
<div class="footer">Xin c·∫£m ∆°n Qu√Ω kh√°ch! H·∫πn g·∫∑p l·∫°i.</div>

<script>

const params = new URLSearchParams(window.location.search);

// Format ti·ªÅn
function formatMoney(number) {
  return Number(number || 0).toLocaleString("vi-VN");
}

// Th√¥ng tin c·ª≠a h√†ng
document.getElementById("storeName").textContent = params.get("tencuahang") || "";
document.getElementById("storeAddress").textContent = "ƒê·ªãa ch·ªâ: " + (params.get("diachicuahang") || "");
document.getElementById("storePhone").textContent = "SƒêT: " + (params.get("dienthoaicuahang") || "");

// Th√¥ng tin ƒë∆°n
const orderId = params.get("id") || "";
document.getElementById("orderId").textContent = orderId;
document.getElementById("ban").textContent = params.get("ban") || "";

// Kh√°ch h√†ng
document.getElementById("customerName").textContent = params.get("ten") || "";
document.getElementById("customerAddress").textContent = params.get("diachi") || "";

// Ti·ªÅn
const tongTien = params.get("thanhtoan");
const giamgia = params.get("giamgia");
const phuthu = params.get("phuthu");
const tongThanhToan = params.get("tongthanhtoan");

document.getElementById("paymentAmount").textContent = formatMoney(tongTien);
document.getElementById("giamgia").textContent = formatMoney(giamgia);
document.getElementById("phuthu").textContent = formatMoney(phuthu);
document.getElementById("tongthanhtoan").textContent = formatMoney(tongThanhToan);

// ·∫®n d√≤ng n·∫øu = 0
if (!giamgia || Number(giamgia) == 0) {
  document.getElementById("giamgiaRow").style.display = "none";
}
if (!phuthu || Number(phuthu) == 0) {
  document.getElementById("phuthuRow").style.display = "none";
}

// Barcode
document.getElementById("barcode").src =
"https://barcode.tec-it.com/barcode.ashx?code=Code128&data=" + orderId;

// Danh s√°ch s·∫£n ph·∫©m
const data = decodeURIComponent(params.get("data") || "").split("_n_");
let tbody = document.querySelector("#productTable tbody");
let totalQty = 0, totalPrice = 0;

data.forEach((row, index) => {
  if (!row.trim()) return;
  const parts = row.split("|");
  const name = parts[1] || "";
  const qty = parseInt(parts[3] || 0);
  const price = parseFloat(parts[4] || 0);
  const amount = parseFloat(parts[5] || 0);

  totalQty += qty;
  totalPrice += amount;

  let tr = document.createElement("tr");
  tr.innerHTML =
    `<td>${index + 1}</td>
     <td>${name}</td>
     <td>${qty}</td>
     <td>${formatMoney(price)}</td>
     <td>${formatMoney(amount)}</td>`;
  tbody.appendChild(tr);
});

document.getElementById("totalQty").textContent = totalQty;
document.getElementById("totalPrice").textContent = formatMoney(totalPrice);

// QR VietQR
const bank = params.get("bank");
const stk = params.get("stk");
const chutk = params.get("chutk");

if (bank && stk && chutk && tongThanhToan) {
  document.getElementById("qrcode").src =
    `https://img.vietqr.io/image/${bank}-${stk}-compact2.jpg?amount=${tongThanhToan}&addInfo=${orderId}&accountName=${chutk}`;
}

// Ng√†y gi·ªù
document.getElementById("datetime").textContent =
"Ng√†y in: " + new Date().toLocaleString("vi-VN");

</script>

</body>
</html>
