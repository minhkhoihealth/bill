<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>In h√≥a ƒë∆°n</title>

<style>
body {
  font-family: Arial;
  width: 72mm;
  margin: 0 auto;
  font-size: 13px;
}

.logo-box {
  text-align: center;
  margin-top: 5px;
}

.logo-box img {
  max-width: 150px;
  max-height: 80px;
}

h2 {
  text-align: center;
  margin: 3px 0;
}

.info {
  text-align: center;
  font-size: 12px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 5px;
}

th, td {
  border-bottom: 1px dashed #000;
  padding: 4px 0;
  font-size: 12px;
}

.right { text-align: right; }
.center { text-align: center; }
.bold { font-weight: bold; }

.note {
  font-size: 11px;
  font-style: italic;
}

.qrcode-box, .barcode-box {
  text-align: center;
  margin-top: 5px;
}

.footer {
  text-align: center;
  margin-top: 8px;
  font-size: 12px;
}

@media print {
  button { display: none; }
}
</style>
</head>

<body>

<div class="logo-box">
  <img id="logo">
</div>

<h2 id="storeName"></h2>
<div class="info" id="storeAddress"></div>
<div class="info" id="storePhone"></div>

<hr>

<div><strong>M√£ ƒë∆°n:</strong> <span id="orderId"></span></div>
<div><strong>B√†n:</strong> <span id="ban"></span></div>
<div><strong>Kh√°ch:</strong> <span id="customerName"></span></div>
<div><strong>ƒê·ªãa ch·ªâ:</strong> <span id="customerAddress"></span></div>

<div class="barcode-box">
  <img id="barcode" width="180">
</div>

<table>
<thead>
<tr>
<th>SP</th>
<th class="center">SL</th>
<th class="right">ƒêG</th>
<th class="right">TT</th>
</tr>
</thead>

<tbody id="productBody"></tbody>

<tfoot>
<tr class="bold">
  <td colspan="3">T·ªîNG C·ªòNG</td>
  <td class="right" id="totalPrice"></td>
</tr>

<tr>
  <td colspan="3">T·ªïng ti·ªÅn</td>
  <td class="right" id="paymentAmount"></td>
</tr>

<tr id="giamgiaRow">
  <td colspan="3">Gi·∫£m gi√°</td>
  <td class="right" id="giamgia"></td>
</tr>

<tr id="phuthuRow">
  <td colspan="3">Ph·ª• thu</td>
  <td class="right" id="phuthu"></td>
</tr>

<tr class="bold" style="font-size:15px;">
  <td colspan="3">T·ªîNG THANH TO√ÅN</td>
  <td class="right" id="tongthanhtoan"></td>
</tr>
</tfoot>
</table>

<div class="qrcode-box">
  <img id="qrcode" width="150">
</div>

<div class="footer" id="datetime"></div>
<div class="footer">C·∫£m ∆°n qu√Ω kh√°ch!</div>

<div style="text-align:center; margin-top:8px;">
  <button onclick="window.print()">üñ®Ô∏è In</button>
  <button onclick="closePage()">‚ùå ƒê√≥ng</button>
</div>
<script>
const params = new URLSearchParams(window.location.search);

function formatMoney(n) {
  return Number(n || 0).toLocaleString("vi-VN");
}

// Logo
const logo = params.get("logo");
if (logo) {
  document.getElementById("logo").src = logo;
} else {
  document.getElementById("logo").style.display = "none";
}

// C·ª≠a h√†ng
document.getElementById("storeName").textContent = params.get("tencuahang") || "";
document.getElementById("storeAddress").textContent = params.get("diachicuahang") || "";
document.getElementById("storePhone").textContent = params.get("dienthoaicuahang") || "";

// ƒê∆°n h√†ng
const orderId = params.get("id") || "";
document.getElementById("orderId").textContent = orderId;
document.getElementById("ban").textContent = params.get("ban") || "";
document.getElementById("customerName").textContent = params.get("ten") || "";
document.getElementById("customerAddress").textContent = params.get("diachi") || "";

// Ti·ªÅn
const tongTien = params.get("thanhtoan");
const giamgia = params.get("giamgia");
const phuthu = params.get("phuthu");
const tongThanhToan = params.get("tongthanhtoan");

document.getElementById("paymentAmount").textContent = formatMoney(tongTien);
document.getElementById("giamgia").textContent = formatMoney(giamgia);
document.getElementById("phuthu").textContent = formatMoney(phuthu);
document.getElementById("tongthanhtoan").textContent = formatMoney(tongThanhToan);

if (!giamgia || Number(giamgia) == 0)
  document.getElementById("giamgiaRow").style.display = "none";

if (!phuthu || Number(phuthu) == 0)
  document.getElementById("phuthuRow").style.display = "none";

// Barcode
document.getElementById("barcode").src =
"https://barcode.tec-it.com/barcode.ashx?code=Code128&data=" + orderId;

// S·∫£n ph·∫©m
const data = decodeURIComponent(params.get("data") || "").split("_n_");
let total = 0;
let tbody = document.getElementById("productBody");

data.forEach(row => {
  if (!row.trim()) return;

  const parts = row.split("|");
  const name = parts[1] || "";
  const note = parts[2] || "";
  const qty = parts[3] || 0;
  const price = parts[4] || 0;
  const amount = parts[5] || 0;

  total += Number(amount);

  let tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${name}${note ? `<div class="note">(${note})</div>` : ""}</td>
    <td class="center">${qty}</td>
    <td class="right">${formatMoney(price)}</td>
    <td class="right">${formatMoney(amount)}</td>
  `;
  tbody.appendChild(tr);
});

document.getElementById("totalPrice").textContent = formatMoney(total);

// QR
const bank = params.get("bank");
const stk = params.get("stk");
const chutk = params.get("chutk");

if (bank && stk && chutk && tongThanhToan) {
  document.getElementById("qrcode").src =
    `https://img.vietqr.io/image/${bank}-${stk}-compact2.jpg?amount=${tongThanhToan}&addInfo=${orderId}&accountName=${encodeURIComponent(chutk)}`;
} else {
  document.getElementById("qrcode").style.display = "none";
}

// Ng√†y gi·ªù
document.getElementById("datetime").textContent =
"Ng√†y in: " + new Date().toLocaleString("vi-VN");

</script>

</body>
</html>
