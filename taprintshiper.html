<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>In h√≥a ƒë∆°n</title>

<style>
body {
  font-family: Arial, Helvetica, sans-serif;
  width: 76mm;
  margin: 0 auto;
  font-size: 13px;
  line-height: 1.6;
  font-weight: 500;
}

/* ===== Logo ===== */
.logo-box {
  text-align: center;
  margin: 8px 0;
}

.logo-box img {
  max-width: 150px;
  max-height: 80px;
}

/* ===== Ti√™u ƒë·ªÅ ===== */
.bill-title {
  text-align: center;
  font-weight: 800;
  font-size: 15px;
  margin: 8px 0;
  letter-spacing: 0.5px;
}

h2 {
  text-align: center;
  margin: 6px 0;
  font-size: 15px;
  font-weight: 800;
}

.info {
  text-align: center;
  font-size: 13px;
  margin-bottom: 4px;
}

/* ===== B·∫£ng ===== */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
}

th {
  font-size: 12px;
  border-bottom: 1.5px dashed #000;
  padding: 8px 0;
  font-weight: 700;
}

td {
  border-bottom: 1px dashed #000;
  padding: 8px 0;
  font-size: 11px;
  vertical-align: top;
}

.right { text-align: right; }
.center { text-align: center; }
.bold { font-weight: 800; }

.note {
  font-size: 13px;
  font-style: italic;
}

/* ===== T·ªïng thanh to√°n n·ªïi b·∫≠t ===== */
tfoot tr:last-child {
  font-size: 16px;
  font-weight: 900;
}

/* ===== QR ===== */
.qrcode-box {
  text-align: center;
  margin-top: 14px;
}

.footer {
  text-align: center;
  margin-top: 10px;
  font-size: 13px;
}

.button-box {
  text-align: center;
  margin-top: 16px;
}

button {
  padding: 6px 12px;
  font-size: 13px;
  margin: 4px;
}

@media print {
  .button-box { display: none; }
}
</style>
</head>

<body>

<div class="logo-box">
  <img id="logo">
</div>

<h2 id="storeName"></h2>
<div class="info" id="storeAddress"></div>
<div class="info" id="storePhone"></div>

<hr>

<div class="bill-title">H√ìA ƒê∆†N THANH TO√ÅN</div>

<div><strong>M√£ ƒë∆°n:</strong> <span id="orderId"></span></div>
<div><strong>B√†n:</strong> <span id="ban"></span></div>
  <div><strong>Nh√¢n vi√™n:</strong> <span id="nhanvien"></span></div>
<div><strong>Kh√°ch:</strong> <span id="customerName"></span></div>
<div><strong>ƒê·ªãa ch·ªâ:</strong> <span id="customerAddress"></span></div>

<table>
<thead>
<tr>
<th>SP</th>
<th class="center">SL</th>
<th class="right">ƒê∆°n gi√°</th>
<th >Th√†nh ti·ªÅn</th>
</tr>
</thead>

<tbody id="productBody"></tbody>

<tfoot>
<tr class="bold">
  <td colspan="3">T·ªîNG C·ªòNG</td>
  <td class="right" id="totalPrice"></td>
</tr>

<tr id="giamgiaRow">
  <td colspan="3">Gi·∫£m gi√°</td>
  <td class="right" id="giamgia"></td>
</tr>

<tr id="phuthuRow">
  <td colspan="3">Ph·ª• thu</td>
  <td class="right" id="phuthu"></td>
</tr>

<tr class="bold">
  <td colspan="3">T·ªîNG THANH TO√ÅN</td>
  <td class="right" id="tongthanhtoan"></td>
</tr>
</tfoot>
</table>

<div class="qrcode-box">
  <img id="qrcode" width="130">
</div>

<div class="footer" id="datetime"></div>
<div class="footer">C·∫£m ∆°n qu√Ω kh√°ch!</div>

<div class="button-box">
  <button onclick="window.print()">üñ® In</button>
  <button onclick="closePage()">‚ùå ƒê√≥ng</button>
</div>

<script>
const params = new URLSearchParams(window.location.search);

function formatMoney(n) {
  return Number(n || 0).toLocaleString("vi-VN");
}

/* ===== Logo ===== */
const logo = params.get("logo");
if (logo && logo.startsWith("http")) {
  document.getElementById("logo").src = logo;
} else {
  document.getElementById("logo").style.display = "none";
}

/* ===== Th√¥ng tin c·ª≠a h√†ng ===== */
document.getElementById("storeName").textContent = params.get("tencuahang") || "";
document.getElementById("storeAddress").textContent = params.get("diachicuahang") || "";
document.getElementById("storePhone").textContent = params.get("dienthoaicuahang") || "";

/* ===== ƒê∆°n h√†ng ===== */
const orderId = params.get("id") || "";
document.getElementById("orderId").textContent = orderId;
document.getElementById("ban").textContent = params.get("ban") || "";
document.getElementById("nhanvien").textContent = params.get("nhanvien") || "";
document.getElementById("customerName").textContent = params.get("ten") || "";
document.getElementById("customerAddress").textContent = params.get("diachi") || "";

/* ===== Ti·ªÅn ===== */
const giamgia = params.get("giamgia");
const phuthu = params.get("phuthu");
const tongThanhToan = params.get("tongthanhtoan");

document.getElementById("giamgia").textContent = formatMoney(giamgia);
document.getElementById("phuthu").textContent = formatMoney(phuthu);
document.getElementById("tongthanhtoan").textContent = formatMoney(tongThanhToan);

if (!giamgia || Number(giamgia) == 0)
  document.getElementById("giamgiaRow").style.display = "none";

if (!phuthu || Number(phuthu) == 0)
  document.getElementById("phuthuRow").style.display = "none";

/* ===== S·∫£n ph·∫©m ===== */
const data = decodeURIComponent(params.get("data") || "").split("_n_");
let total = 0;
let tbody = document.getElementById("productBody");

data.forEach(row => {
  if (!row.trim()) return;

  const parts = row.split("|");
  const name = parts[1] || "";
  const note = parts[2] || "";
  const qty = parts[3] || 0;
  const price = parts[4] || 0;
  const amount = parts[5] || 0;

  total += Number(amount);

  let tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${name}${note ? `<div class="note">(${note})</div>` : ""}</td>
    <td class="center">${qty}</td>
    <td class="right">${formatMoney(price)}</td>
    <td >${formatMoney(amount)}</td>
  `;
  tbody.appendChild(tr);
});

document.getElementById("totalPrice").textContent = formatMoney(total);

/* ===== QR ===== */
const bank = params.get("bank");
const stk = params.get("stk");
const chutk = params.get("chutk");

if (bank && stk && chutk && tongThanhToan) {
  document.getElementById("qrcode").src =
    `https://img.vietqr.io/image/${bank}-${stk}-compact2.jpg?amount=${tongThanhToan}&addInfo=${orderId}&accountName=${encodeURIComponent(chutk)}`;
} else {
  document.getElementById("qrcode").style.display = "none";
}

/* ===== Ng√†y gi·ªù ===== */
document.getElementById("datetime").textContent =
"Ng√†y in: " + new Date().toLocaleString("vi-VN");

/* ===== ƒê√≥ng trang ===== */
function closePage() {
  window.close();
  setTimeout(() => {
    window.history.back();
  }, 300);
}
</script>

</body>
</html>
